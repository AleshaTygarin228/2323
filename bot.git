import asyncio
import logging
from datetime import datetime, timedelta
from collections import defaultdict
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
API_TOKEN = '7376356447:AAGY1sKeKWBNA6tw3GOMNmtxaVFTq5tU9is'
REMINDER_INTERVAL = 6 * 3600  # 6 —á–∞—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
bot = Bot(token=API_TOKEN)
dp = Dispatcher()

# –•—Ä–∞–Ω–∏–ª–∏—â–∞
active_chats = set()
user_stats = defaultdict(lambda: defaultdict(lambda: {
    'message_count': 0,
    'username': '',
    'first_name': '',
    'last_name': ''
}))


def get_user_display_name(user_info):
    """–§–æ—Ä–º–∏—Ä—É–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    name_parts = []
    if user_info['first_name']:
        name_parts.append(user_info['first_name'])
    if user_info['last_name']:
        name_parts.append(user_info['last_name'])

    if name_parts:
        return ' '.join(name_parts)
    elif user_info['username']:
        return f"@{user_info['username']}"
    else:
        return "–ê–Ω–æ–Ω–∏–º"


@dp.message(Command("start"))
async def start_reminder(message: types.Message):
    chat_id = message.chat.id
    active_chats.add(chat_id)

    await message.answer(
        "üèä –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã! –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤ —è –±—É–¥—É –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å "
        "—Å–∫–∏–Ω—É—Ç—å—Å—è –Ω–∞ –±–∞–Ω—å–∫—É –ø–∞—Ä–∏–ª–∫—É –µ–±–ª—è –∏–≥–æ—Ä–∏–ª–∫—É , –∞ —Ç–∞–∫–∂–µ –Ω–∞ –±—É—Ö–ª–∏—à–∫–æ –∑–∞–ª–∏–≤–Ω–æ–µ –∏ –∑–∞–∫—É—Å–æ—á–∫—É —Å–º–∞—á–Ω—É—é üçª\n\n"
        "–¢–∞–∫–∂–µ —è –≤–µ–¥—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ üìä\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è\n"
        "/stats_week - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é\n"
        "/stop - –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è"
    )

    # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è —á–∞—Ç–∞
    asyncio.create_task(send_periodic_reminders(chat_id))


async def send_periodic_reminders(chat_id: int):
    while chat_id in active_chats:
        try:
            await bot.send_message(
                chat_id,
                "‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ! –ü–æ—Ä–∞ —Å–∫–∏–Ω—É—Ç—å—Å—è –Ω–∞ –±–∞–Ω—å–∫—É –ø–∞—Ä–∏–ª–∫—É –µ–±–ª—è –∏–≥–æ—Ä–∏–ª–∫—É , –∞ —Ç–∞–∫–∂–µ –Ω–∞ –±—É—Ö–ª–∏—à–∫–æ –∑–∞–ª–∏–≤–Ω–æ–µ –∏ –∑–∞–∫—É—Å–æ—á–∫—É —Å–º–∞—á–Ω—É—é üçª üßäüç¥\n\n"

            )
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —á–∞—Ç {chat_id}: {e}")
            active_chats.discard(chat_id)
            break

        await asyncio.sleep(REMINDER_INTERVAL)


@dp.message(Command("stop"))
async def stop_reminder(message: types.Message):
    active_chats.discard(message.chat.id)
    await message.answer("–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã ‚ùå")


@dp.message(Command("stats"))
async def show_stats(message: types.Message):
    chat_id = message.chat.id

    if chat_id not in user_stats:
        await message.answer("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞ –ø—É—Å—Ç–∞ üì≠")
        return

    chat_stat = user_stats[chat_id]
    if not chat_stat:
        await message.answer("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞ –ø—É—Å—Ç–∞ üì≠")
        return

    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–æ–æ–±—â–µ–Ω–∏–π
    sorted_stats = sorted(
        chat_stat.items(),
        key=lambda x: x[1]['message_count'],
        reverse=True
    )

    stats_text = "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (–≤—Å–µ –≤—Ä–µ–º—è):\n\n"
    for i, (user_id, user_info) in enumerate(sorted_stats[:10], 1):  # –¢–æ–ø-10
        display_name = get_user_display_name(user_info)
        stats_text += f"{i}. {display_name}: {user_info['message_count']} —Å–æ–æ–±—â.\n"

    await message.answer(stats_text)


@dp.message(Command("stats_week"))
async def show_weekly_stats(message: types.Message):
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é"""
    chat_id = message.chat.id

    # –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∑–¥–µ—Å—å –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –¥–∞—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π
    # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    await show_stats(message)


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Å–±–æ—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
@dp.message()
async def count_message(message: types.Message):
    # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∫–æ–º–∞–Ω–¥—ã
    if not message.from_user:
        return

    chat_id = message.chat.id
    user_id = message.from_user.id

    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    user_stats[chat_id][user_id]['message_count'] += 1
    user_stats[chat_id][user_id]['username'] = message.from_user.username or ''
    user_stats[chat_id][user_id]['first_name'] = message.from_user.first_name or ''
    user_stats[chat_id][user_id]['last_name'] = message.from_user.last_name or ''


@dp.message(Command("top3"))
async def show_top3(message: types.Message):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ø-3 —Å–∞–º—ã—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"""
    chat_id = message.chat.id

    if chat_id not in user_stats or not user_stats[chat_id]:
        await message.answer("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞ –ø—É—Å—Ç–∞ üì≠")
        return

    chat_stat = user_stats[chat_id]
    sorted_stats = sorted(
        chat_stat.items(),
        key=lambda x: x[1]['message_count'],
        reverse=True
    )[:3]  # –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ–ø-3

    stats_text = "üèÜ –¢–æ–ø-3 —Å–∞–º—ã—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:\n\n"
    medals = ["ü•á", "ü•à", "ü•â"]

    for i, (user_id, user_info) in enumerate(sorted_stats):
        display_name = get_user_display_name(user_info)
        stats_text += f"{medals[i]} {display_name}: {user_info['message_count']} —Å–æ–æ–±—â.\n"

    await message.answer(stats_text)


@dp.message(Command("mystats"))
async def show_my_stats(message: types.Message):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    chat_id = message.chat.id
    user_id = message.from_user.id

    if (chat_id in user_stats and
            user_id in user_stats[chat_id]):

        user_info = user_stats[chat_id][user_id]
        display_name = get_user_display_name(user_info)

        stats_text = (
            f"üìà –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, {display_name}:\n\n"
            f"üí¨ –°–æ–æ–±—â–µ–Ω–∏–π: {user_info['message_count']}\n"
            f"üèÜ –ú–µ—Å—Ç–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ: "
        )

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ
        chat_stat = user_stats[chat_id]
        sorted_stats = sorted(
            chat_stat.items(),
            key=lambda x: x[1]['message_count'],
            reverse=True
        )

        for i, (uid, _) in enumerate(sorted_stats, 1):
            if uid == user_id:
                stats_text += f"{i}\n"
                break

        await message.answer(stats_text)
    else:
        await message.answer("–í–∞—à–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –µ—â–µ –Ω–µ—Ç –≤ —ç—Ç–æ–º —á–∞—Ç–µ üì≠")


async def main():
    logging.basicConfig(
        level=logging.INFO,
        format="%(asctime)s - %(levelname)s - %(name)s - %(message)s",
    )

    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –º–µ–Ω—é –±–æ—Ç–∞
    await bot.set_my_commands([
        types.BotCommand(command="start", description="–ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è"),
        types.BotCommand(command="stats", description="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π"),
        types.BotCommand(command="top3", description="–¢–æ–ø-3 –∞–∫—Ç–∏–≤–Ω—ã—Ö"),
        types.BotCommand(command="mystats", description="–ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"),
        types.BotCommand(command="stop", description="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è"),
    ])

    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())
